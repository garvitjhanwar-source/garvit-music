<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garvit Music</title>
    
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2402/2402462.png">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        body { background: #030303; color: white; font-family: 'Roboto', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* TOP BAR */
        .top-bar { padding: 15px 20px; background: #121212; display: flex; align-items: center; gap: 20px; border-bottom: 1px solid #333; justify-content: space-between; }
        .left-section { display: flex; align-items: center; gap: 20px; flex: 1; }
        .brand { display: flex; align-items: center; gap: 10px; text-decoration: none; color: white; font-weight: bold; font-size: 20px; letter-spacing: -0.5px; }
        .brand img { width: 34px; height: 34px; } 

        .search-container { position: relative; width: 100%; max-width: 500px; }
        .search-input { width: 100%; padding: 12px; background: #222; border: 1px solid transparent; color: white; border-radius: 25px; font-size: 16px; outline: none; padding-left: 20px; transition: 0.3s; }
        .search-input:focus { background: #000; border-color: #ff0000; box-shadow: 0 0 10px rgba(255, 0, 0, 0.2); }
        .loading-spinner { position: absolute; right: 15px; top: 10px; display: none; }
        
        .user-profile { display: flex; align-items: center; gap: 10px; min-width: 140px; justify-content: flex-end; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; display: none; object-fit: cover; border: 2px solid #333; }
        .user-name { font-size: 14px; font-weight: 500; display: none; }
        .logout-btn { background: #222; border: 1px solid #333; color: #aaa; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 11px; display: none; transition: 0.2s; margin-left: 5px; }
        .logout-btn:hover { background: #ff0000; color: white; border-color: #ff0000; }

        /* MAIN AREA */
        .main-content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; }
        
        /* RESULTS GRID */
        .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .card { background: #181818; padding: 15px; border-radius: 8px; cursor: pointer; transition: 0.2s; position: relative; }
        .card:hover { background: #282828; transform: translateY(-5px); }
        .card img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 4px; margin-bottom: 10px; background: #333; }
        .card h3 { font-size: 14px; margin: 0 0 5px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
        .card p { font-size: 12px; color: #aaa; margin: 0; }

        /* --- SPEED DIAL STYLES --- */
        .speed-dial-container { margin-top: 10px; margin-bottom: 40px; }
        .section-title { font-size: 22px; font-weight: bold; margin-bottom: 15px; color: #fff; border-left: 4px solid #ff0000; padding-left: 10px; }
        .speed-dial-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        
        .dial-card { 
            height: 80px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; padding: 0 20px;
            font-size: 18px; font-weight: bold; overflow: hidden; position: relative; transition: transform 0.2s;
            background: #222; border: 1px solid #333;
        }
        .dial-card:hover { transform: scale(1.02); border-color: #fff; }
        .dial-card i { margin-right: 10px; font-size: 24px; }

        /* User Playlist Colors */
        .user-dial { background: linear-gradient(135deg, #1e1e1e, #3a3a3a); border-left: 5px solid #ff0000; }
        
        /* Preset Colors */
        .dial-1 { background: linear-gradient(135deg, #8E2DE2, #4A00E0); }
        .dial-2 { background: linear-gradient(135deg, #FF512F, #DD2476); }
        .dial-3 { background: linear-gradient(135deg, #11998e, #38ef7d); }
        .dial-4 { background: linear-gradient(135deg, #C33764, #1D2671); }

        /* PLAYER BAR */
        .player-bar { position: fixed; bottom: 0; width: 100%; height: 80px; background: #212121; border-top: 1px solid #333; display: flex; align-items: center; padding: 0 20px; box-sizing: border-box; justify-content: space-between; z-index: 100; }
        .song-info { display: flex; align-items: center; width: 30%; }
        .song-info img { width: 50px; height: 50px; margin-right: 15px; background: #333; border-radius: 4px; }
        .info-text h3 { font-size: 14px; margin: 0; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .info-text p { font-size: 12px; color: #aaa; margin: 0; }
        
        .controls { display: flex; flex-direction: column; align-items: center; width: 40%; }
        .buttons { display: flex; align-items: center; gap: 20px; margin-bottom: 5px; }
        .btn { background: none; border: none; color: #ddd; cursor: pointer; transition: 0.2s; }
        .btn:hover { color: white; transform: scale(1.1); }
        .play-btn { background: white; color: black; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .play-btn:hover { transform: scale(1.1); background: #ff0000; color: white; }
        
        .progress-area { width: 100%; display: flex; align-items: center; gap: 10px; font-size: 11px; color: #aaa; }
        .progress-bar { flex: 1; height: 4px; background: #444; cursor: pointer; position: relative; border-radius: 2px; }
        .progress-fill { height: 100%; background: #ff0000; width: 0%; border-radius: 2px; box-shadow: 0 0 10px #ff0000; } 

        /* Right side of player (Add to Playlist) */
        .player-actions { width: 30%; display: flex; justify-content: flex-end; gap: 15px; }
        .action-btn { color: #aaa; background: none; border: none; cursor: pointer; }
        .action-btn:hover { color: #ff0000; }

        #hidden-player { position: fixed; bottom: 90px; right: 20px; width: 320px; height: 180px; z-index: 50; background: black; border: 2px solid #333; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.6); transition: 0.3s; }
        #hidden-player:hover { width: 360px; height: 202px; border-color: #ff0000; }
        .spinner { border: 3px solid rgba(255,0,0,0.3); border-radius: 50%; border-top: 3px solid #ff0000; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="left-section">
            <a href="/" class="brand">
                <img src="https://cdn-icons-png.flaticon.com/512/2402/2402462.png" alt="Logo">
                Garvit Music
            </a>
            <div class="search-container">
                <input type="text" id="search" class="search-input" placeholder="Search for songs...">
                <div id="loader" class="loading-spinner spinner"></div>
            </div>
        </div>

        <div class="user-profile">
            <div id="googleBtnWrapper">
                <div id="g_id_onload"
                     data-client_id="1008834040580-n0hmhrtr6cmho2prg3i992hq5l77lpd7.apps.googleusercontent.com" 
                     data-callback="handleCredentialResponse"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="filled_black" data-text="signin_with" data-size="medium"></div>
            </div>
            <img id="userPic" class="user-avatar" src="">
            <span id="userName" class="user-name"></span>
            <button id="logoutBtn" class="logout-btn" onclick="logout()">Sign Out</button>
        </div>
    </div>

    <div class="main-content" id="mainArea">
        
        <div id="librarySection" class="speed-dial-container">
            <div class="section-title">Your Library</div>
            <div class="speed-dial-grid" id="libraryGrid">
                </div>
        </div>

        <div id="speedDial" class="speed-dial-container">
            <div class="section-title">Discover</div>
            <div class="speed-dial-grid">
                <div class="dial-card dial-1" onclick="quickSearch('Trending Music India')">ðŸ”¥ Trending</div>
                <div class="dial-card dial-2" onclick="quickSearch('Punjabi Hits 2024')">ðŸ‘³ Punjabi Hits</div>
                <div class="dial-card dial-3" onclick="quickSearch('Lofi Beats')">â˜• Lofi Beats</div>
                <div class="dial-card dial-4" onclick="quickSearch('Gym Workout Music')">ðŸ’ª Gym Mode</div>
            </div>
        </div>

        <div id="results" class="results-grid"></div>
    </div>

    <footer class="player-bar">
        <div class="song-info">
            <img id="art" src="">
            <div class="info-text">
                <h3 id="title">Select a song</h3>
                <p id="artist">...</p>
            </div>
        </div>
        <div class="controls">
            <div class="buttons">
                <button class="btn"><i class="material-icons">skip_previous</i></button>
                <button class="btn play-btn" onclick="togglePlay()"><i class="material-icons" id="playIcon">play_arrow</i></button>
                <button class="btn"><i class="material-icons">skip_next</i></button>
            </div>
            <div class="progress-area">
                <span id="curTime">0:00</span>
                <div class="progress-bar" onclick="seek(event)"><div class="progress-fill" id="fill"></div></div>
                <span id="durTime">0:00</span>
            </div>
        </div>
        <div class="player-actions">
            <button class="action-btn" onclick="addToPlaylist()" title="Add to Playlist">
                <i class="material-icons">playlist_add</i>
            </button>
             <button class="action-btn" onclick="likeSong()" title="Like Song">
                <i class="material-icons">favorite_border</i>
            </button>
        </div>
    </footer>

    <div id="hidden-player"></div>

    <script>
        // --- 1. MEMORY & LOGIN ---
        let currentSong = null; // Track what is playing

        window.onload = function() {
            const savedUser = localStorage.getItem('garvit_user');
            if (savedUser) {
                const user = JSON.parse(savedUser);
                showLoggedInState(user);
            }
            renderLibrary(); // Load user playlists
        };
        function handleCredentialResponse(response) {
            const payload = decodeJwtResponse(response.credential);
            const user = { name: payload.given_name, pic: payload.picture };
            localStorage.setItem('garvit_user', JSON.stringify(user));
            showLoggedInState(user);
        }
        function showLoggedInState(user) {
            document.getElementById('googleBtnWrapper').style.display = 'none';
            const pic = document.getElementById('userPic');
            pic.src = user.pic;
            pic.style.display = 'block';
            const name = document.getElementById('userName');
            name.innerText = user.name; 
            name.style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'block';
        }
        function logout() { localStorage.removeItem('garvit_user'); location.reload(); }
        function decodeJwtResponse(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            return JSON.parse(decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join('')));
        }

        // --- 2. PLAYLIST SYSTEM (NEW) ---
        function getPlaylists() {
            const stored = localStorage.getItem('garvit_playlists');
            return stored ? JSON.parse(stored) : {};
        }

        function addToPlaylist() {
            if(!currentSong) { alert("Play a song first!"); return; }
            
            const name = prompt("Enter Playlist Name (e.g. Gym, Sleep, Favorites):");
            if(!name) return;

            const playlists = getPlaylists();
            if(!playlists[name]) playlists[name] = [];
            
            // Check if song exists
            const exists = playlists[name].find(s => s.id === currentSong.id);
            if(!exists) {
                playlists[name].push(currentSong);
                localStorage.setItem('garvit_playlists', JSON.stringify(playlists));
                renderLibrary();
                alert(`Added to ${name}!`);
            } else {
                alert("Song already in playlist!");
            }
        }

        function renderLibrary() {
            const grid = document.getElementById('libraryGrid');
            const playlists = getPlaylists();
            grid.innerHTML = '';

            const names = Object.keys(playlists);
            if(names.length === 0) {
                grid.innerHTML = '<p style="color:#555; font-size:14px;">No playlists yet. Play a song and click (+) to create one.</p>';
                return;
            }

            names.forEach(name => {
                const div = document.createElement('div');
                div.className = 'dial-card user-dial';
                div.innerHTML = `<i class="material-icons">queue_music</i> ${name}`;
                div.onclick = () => openPlaylist(name);
                grid.appendChild(div);
            });
        }

        function openPlaylist(name) {
            const playlists = getPlaylists();
            const songs = playlists[name];
            
            document.getElementById('speedDial').style.display = 'none';
            document.getElementById('librarySection').style.display = 'none';
            
            const results = document.getElementById('results');
            results.innerHTML = `<h2 style="grid-column:1/-1; margin-bottom:20px;">ðŸ“‚ Playlist: ${name} <button onclick="location.reload()" style="float:right; background:#333; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Close</button></h2>`;
            
            songs.forEach(song => {
                const div = document.createElement('div');
                div.className = 'card';
                div.onclick = () => playSong(song);
                div.innerHTML = `<img src="${song.cover}"><h3>${song.title}</h3><p>${song.artist}</p>`;
                results.appendChild(div);
            });
        }

        // --- 3. SEARCH & PLAYER ---
        const searchInput = document.getElementById('search');
        const resultsDiv = document.getElementById('results');
        const speedDialDiv = document.getElementById('speedDial');
        const libraryDiv = document.getElementById('librarySection');
        const loader = document.getElementById('loader');
        let timer;

        function quickSearch(term) { searchInput.value = term; doSearch(term); }

        searchInput.addEventListener('input', (e) => {
            clearTimeout(timer); 
            timer = setTimeout(() => doSearch(e.target.value), 500);
        });

        async function doSearch(query) {
            if(!query) {
                speedDialDiv.style.display = 'block';
                libraryDiv.style.display = 'block';
                resultsDiv.innerHTML = '';
                return;
            }
            speedDialDiv.style.display = 'none';
            libraryDiv.style.display = 'none';
            loader.style.display = 'block';
            
            try {
                const res = await fetch(`https://pipedapi.kavin.rocks/search?q=${query}&filter=music_songs`);
                const data = await res.json();
                const songs = data.items.map(item => ({
                    id: item.url.split('v=')[1],
                    title: item.title,
                    artist: item.uploaderName,
                    cover: item.thumbnail
                }));
                render(songs);
            } catch(err) { console.error(err); }
            loader.style.display = 'none';
        }

        function render(songs) {
            resultsDiv.innerHTML = '';
            songs.forEach(song => {
                const div = document.createElement('div');
                div.className = 'card';
                div.onclick = () => playSong(song);
                div.innerHTML = `<img src="${song.cover}"><h3>${song.title}</h3><p>${song.artist}</p>`;
                resultsDiv.appendChild(div);
            });
        }

        var player, isPlayerReady = false;
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('hidden-player', {
                height: '100%', width: '100%',
                events: { 'onReady': () => isPlayerReady = true, 'onStateChange': onStateChange }
            });
        }
        function onStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                document.getElementById('playIcon').innerText = 'pause'; startLoop();
            } else {
                document.getElementById('playIcon').innerText = 'play_arrow'; stopLoop();
            }
        }
        function playSong(song) {
            currentSong = song; // SAVE CURRENT SONG FOR PLAYLISTS
            if(!isPlayerReady) return;
            document.getElementById('title').innerText = song.title;
            document.getElementById('artist').innerText = song.artist;
            document.getElementById('art').src = song.cover;
            player.loadVideoById(song.id);
            player.playVideo();
        }
        function togglePlay() {
            if(!player) return;
            player.getPlayerState() === 1 ? player.pauseVideo() : player.playVideo();
        }
        let interval;
        function startLoop() {
            clearInterval(interval);
            interval = setInterval(() => {
                if(!player || !player.getCurrentTime) return;
                const c = player.getCurrentTime(), d = player.getDuration();
                if(d > 0) {
                    document.getElementById('fill').style.width = (c/d)*100 + '%';
                    document.getElementById('curTime').innerText = fmt(c);
                    document.getElementById('durTime').innerText = fmt(d);
                }
            }, 500);
        }
        function stopLoop() { clearInterval(interval); }
        function fmt(s) { return Math.floor(s/60) + ":" + (Math.floor(s%60)<10?"0":"") + Math.floor(s%60); }
        function seek(e) {
            const rect = e.target.getBoundingClientRect();
            player.seekTo(player.getDuration() * ((e.clientX - rect.left) / rect.width), true);
        }
    </script>
</body>
</html>