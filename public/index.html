<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garvit Music</title>
    
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2402/2402462.png">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        /* --- BASE STYLES --- */
        body { background: #030303; color: white; font-family: 'Roboto', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* --- TOP BAR --- */
        .top-bar { padding: 15px 20px; background: #121212; display: flex; align-items: center; justify-content: space-between; height: 60px; border-bottom: 1px solid #333; box-sizing: border-box; position: relative; }
        .brand { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 20px; color: white; text-decoration: none; z-index: 10; }
        .brand img { width: 34px; height: 34px; }
        
        .search-trigger { background: none; border: none; color: white; cursor: pointer; padding: 10px; border-radius: 50%; transition: 0.2s; z-index: 10; }
        .search-trigger:hover { background: #222; color: #ff0000; }

        .search-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #121212; display: flex; align-items: center; padding: 0 20px; box-sizing: border-box; z-index: 20; transform: translateY(-100%); transition: transform 0.3s ease; }
        .search-overlay.active { transform: translateY(0); }
        .search-input { flex: 1; padding: 12px; background: #222; border: 1px solid #333; color: white; border-radius: 25px; font-size: 16px; outline: none; padding-left: 20px; margin: 0 10px; }
        .search-input:focus { border-color: #ff0000; background: #000; }
        .close-search { background: none; border: none; color: #aaa; cursor: pointer; padding: 10px; }
        .close-search:hover { color: white; }

        .user-profile { display: flex; align-items: center; gap: 10px; z-index: 10; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; display: none; object-fit: cover; border: 2px solid #333; }
        .logout-btn { background: #222; border: 1px solid #333; color: #aaa; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 11px; display: none; }
        
        /* --- MAIN LAYOUT --- */
        .main-content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; }
        
        /* --- SPEED DIAL --- */
        .speed-dial-container { margin-bottom: 40px; }
        .section-title { font-size: 22px; font-weight: bold; margin-bottom: 15px; color: #fff; border-left: 4px solid #ff0000; padding-left: 10px; }
        .speed-dial-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .dial-card { height: 80px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; padding: 0 20px; font-size: 18px; font-weight: bold; background: #222; border: 1px solid #333; overflow: hidden; transition: transform 0.2s; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .dial-card:hover { transform: scale(1.03); border-color: #fff; }
        
        .dial-1 { background: linear-gradient(135deg, #8E2DE2, #4A00E0); }
        .dial-2 { background: linear-gradient(135deg, #FF512F, #DD2476); }
        .dial-3 { background: linear-gradient(135deg, #11998e, #38ef7d); }
        .dial-4 { background: linear-gradient(135deg, #C33764, #1D2671); }
        .dial-5 { background: linear-gradient(135deg, #ff0000, #611111); }
        .user-dial { background: linear-gradient(135deg, #1e1e1e, #3a3a3a); border-left: 5px solid #ff0000; }

        /* --- CARDS --- */
        .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .card { background: #181818; padding: 15px; border-radius: 8px; cursor: pointer; transition: 0.2s; position: relative; }
        .card:hover { background: #282828; transform: translateY(-5px); }
        .card img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 4px; margin-bottom: 10px; background: #333; }
        .card h3 { font-size: 14px; margin: 0 0 5px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
        .card p { font-size: 12px; color: #aaa; margin: 0; }
        
        .action-btn { position: absolute; top: 20px; right: 20px; width: 35px; height: 35px; border-radius: 50%; background: rgba(0,0,0,0.7); color: white; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transform: translateY(10px); transition: all 0.2s ease; z-index: 10; }
        .card:hover .action-btn { opacity: 1; transform: translateY(0); }
        .action-btn:hover { background: #ff0000; border-color: #ff0000; transform: scale(1.1); }
        .delete-btn:hover { background: #D50000 !important; }

        /* --- PLAYER BAR & VISUALIZER (UPDATED FAST VERSION) --- */
        .player-bar { position: fixed; bottom: 0; width: 100%; height: 80px; background: #212121; border-top: 1px solid #333; display: flex; align-items: center; padding: 0 20px; box-sizing: border-box; justify-content: space-between; z-index: 100; }
        .song-info { display: flex; align-items: center; width: 30%; position: relative; }
        .song-info img { width: 50px; height: 50px; margin-right: 15px; background: #333; border-radius: 4px; z-index: 2; }
        
        /* Visualizer Styles */
        .music-waves { display: flex; align-items: flex-end; height: 30px; gap: 3px; margin-left: 10px; opacity: 0; transition: opacity 0.2s; }
        .music-waves.active { opacity: 1; }
        .bar { width: 4px; background: #ff0000; border-radius: 2px; height: 2px; }
        
        /* Faster Animations */
        .music-waves.active .bar { animation: wave 0.5s linear infinite; }
        
        /* Randomized speeds for a "beat" effect */
        .music-waves.active .bar:nth-child(1) { animation-duration: 0.3s; animation-delay: 0s; }
        .music-waves.active .bar:nth-child(2) { animation-duration: 0.45s; animation-delay: 0.1s; }
        .music-waves.active .bar:nth-child(3) { animation-duration: 0.25s; animation-delay: 0.2s; }
        .music-waves.active .bar:nth-child(4) { animation-duration: 0.35s; animation-delay: 0.05s; }

        @keyframes wave {
            0% { height: 2px; opacity: 0.3; }
            20% { height: 28px; opacity: 1; }  /* Jump up fast */
            40% { height: 10px; opacity: 0.8; } /* Dip */
            60% { height: 20px; opacity: 1; }   /* Jump again */
            100% { height: 2px; opacity: 0.3; }
        }

        .info-text h3 { font-size: 14px; margin: 0; margin-bottom: 4px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 200px; }
        .info-text p { font-size: 12px; color: #aaa; margin: 0; }
        .controls { display: flex; align-items: center; gap: 20px; width: 40%; justify-content: center; }
        .play-btn { background: white; color: black; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .play-btn:hover { transform: scale(1.1); background: #ff0000; color: white; }

        #hidden-player { position: fixed; bottom: 90px; right: 20px; width: 320px; height: 180px; z-index: 50; background: black; border: 2px solid #333; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.6); transition: 0.3s; opacity: 0; pointer-events: none; }
        #hidden-player.active { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body>

    <div class="top-bar">
        <a href="/" class="brand">
            <img src="https://cdn-icons-png.flaticon.com/512/2402/2402462.png" alt="Logo">
            Garvit Music
        </a>
        
        <button class="search-trigger" onclick="toggleSearchUI(true)">
            <i class="material-icons">search</i>
        </button>

        <div class="user-profile">
            <div id="googleBtn"></div>
            <img id="userPic" class="user-avatar" src="">
            <span id="userName" style="font-size:14px; display:none; margin-right:10px;"></span>
            <button id="logoutBtn" class="logout-btn" onclick="logout()">Sign Out</button>
        </div>

        <div class="search-overlay" id="searchOverlay">
            <button class="close-search" onclick="toggleSearchUI(false)">
                <i class="material-icons">arrow_back</i>
            </button>
            <input type="text" id="search" class="search-input" placeholder="Search song/artist..." autocomplete="off">
        </div>
    </div>

    <div class="main-content" id="mainArea">
        
        <div id="librarySection" class="speed-dial-container">
            <div class="section-title">Your Library</div>
            <div class="speed-dial-grid" id="libraryGrid">
            </div>
        </div>

        <div id="speedDial" class="speed-dial-container">
            <div class="section-title">Discover</div>
            <div class="speed-dial-grid">
                <div class="dial-card dial-1" onclick="quickSearch('Trending Music India')">ðŸ”¥ Trending</div>
                <div class="dial-card dial-2" onclick="quickSearch('Punjabi Hits 2024')">ðŸ‘³ Punjabi Hits</div>
                <div class="dial-card dial-3" onclick="quickSearch('Lofi Beats')">â˜• Lofi Beats</div>
                <div class="dial-card dial-4" onclick="quickSearch('Gym Workout Music')">ðŸ’ª Gym Mode</div>
                <div class="dial-card dial-5" onclick="quickSearch('Phonk Songs')">ðŸŽ§ Phonk Songs</div>
            </div>
        </div>

        <div id="resultsTitle" class="section-title" style="display:none; margin-top:20px;">Search Results</div>
        <div id="results" class="results-grid"></div>
    </div>

    <footer class="player-bar">
        <div class="song-info">
            <img id="art" src="">
            <div class="info-text">
                <h3 id="title">Select a song</h3>
                <p id="artist">...</p>
            </div>
            <div class="music-waves" id="waves">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>
        </div>
        <div class="controls">
            <button class="play-btn" onclick="togglePlay()"><i class="material-icons" id="playIcon">play_arrow</i></button>
        </div>
        <div style="width:30%"></div>
    </footer>

    <div id="hidden-player"></div>

    <script>
        // --- GLOBAL STATE ---
        let currentUser = null; 
        const searchInput = document.getElementById('search');
        let timer;

        // --- SEARCH UI LOGIC ---
        function toggleSearchUI(show) {
            const overlay = document.getElementById('searchOverlay');
            if (show) {
                overlay.classList.add('active');
                setTimeout(() => searchInput.focus(), 300);
            } else {
                overlay.classList.remove('active');
                if(!searchInput.value) resetView(); 
            }
        }

        searchInput.addEventListener('input', (e) => { 
            clearTimeout(timer); 
            if(!e.target.value) { return; }
            timer = setTimeout(() => doSearch(e.target.value), 800); 
        });
        
        function quickSearch(term) {
            toggleSearchUI(true);
            searchInput.value = term;
            doSearch(term);
        }

        function resetView() {
            document.getElementById('speedDial').style.display = 'block';
            document.getElementById('librarySection').style.display = 'block';
            document.getElementById('results').innerHTML = '';
            document.getElementById('resultsTitle').style.display = 'none';
        }

        async function doSearch(query) {
            if(!query) return;
            document.getElementById('speedDial').style.display = 'none';
            document.getElementById('librarySection').style.display = 'none';
            document.getElementById('resultsTitle').style.display = 'block';
            document.getElementById('resultsTitle').innerText = `Searching: ${query}...`;
            document.getElementById('results').innerHTML = '';

            try {
                const res = await fetch(`/search?q=${encodeURIComponent(query)}`);
                const data = await res.json();
                
                document.getElementById('resultsTitle').innerText = "Results";
                const div = document.getElementById('results');
                div.innerHTML = '';

                if(data.items) {
                    data.items.forEach(song => {
                        const el = document.createElement('div');
                        el.className = 'card';
                        el.onclick = () => playSong(song);

                        const btn = document.createElement('button');
                        btn.className = 'action-btn';
                        btn.innerHTML = '<i class="material-icons">add</i>';
                        btn.title = "Add to Library";
                        btn.onclick = (e) => { e.stopPropagation(); addToPlaylist(song); };

                        el.innerHTML = `<img src="${song.cover}"><h3>${song.title}</h3><p>${song.artist}</p>`;
                        el.appendChild(btn);
                        div.appendChild(el);
                    });
                }
            } catch (err) {
                console.error(err);
                document.getElementById('resultsTitle').innerText = "Error searching.";
            }
        }

        // --- DATA MANAGEMENT ---
        function getStoredPlaylists() {
            if (currentUser && currentUser.playlists) return currentUser.playlists;
            return JSON.parse(localStorage.getItem('garvit_playlists') || '{}');
        }

        async function saveStoredPlaylists(playlists) {
            if (currentUser) {
                currentUser.playlists = playlists;
                await fetch('/api/playlists', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentUser.email, playlists: playlists })
                });
            } else {
                localStorage.setItem('garvit_playlists', JSON.stringify(playlists));
            }
            renderLibrary();
        }

        function handleCredentialResponse(response) {
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: payload.email, name: payload.name, picture: payload.picture })
            })
            .then(res => res.json())
            .then(user => {
                currentUser = user;
                showLoggedInUI();
                renderLibrary();
            });
        }

        function showLoggedInUI() {
            document.getElementById('googleBtn').style.display = 'none';
            document.getElementById('userPic').src = currentUser.picture;
            document.getElementById('userPic').style.display = 'block';
            document.getElementById('userName').innerText = currentUser.name;
            document.getElementById('userName').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'block';
        }

        function addToPlaylist(song) {
            const name = prompt("Add to playlist:", "Favorites");
            if(!name) return;

            let playlists = getStoredPlaylists();
            if(!playlists[name]) playlists[name] = [];
            
            if(!playlists[name].find(s => s.id === song.id)) {
                playlists[name].push(song);
                saveStoredPlaylists(playlists);
                alert(`Added to ${name}!`);
            } else {
                alert("Song already in playlist!");
            }
        }

        function removeFromPlaylist(pName, sId) {
            if(confirm("Remove this song?")) {
                let playlists = getStoredPlaylists();
                playlists[pName] = playlists[pName].filter(s => s.id !== sId);
                saveStoredPlaylists(playlists);
                openPlaylist(pName);
            }
        }

        function renderLibrary() {
            const grid = document.getElementById('libraryGrid');
            const playlists = getStoredPlaylists();
            grid.innerHTML = '';

            if (Object.keys(playlists).length === 0) {
                grid.innerHTML = '<div style="color:#666; padding:10px;">Empty. Search and add songs!</div>';
                return;
            }

            Object.keys(playlists).forEach(name => {
                const el = document.createElement('div');
                el.className = 'dial-card user-dial';
                el.innerHTML = `<i class="material-icons" style="margin-right:10px">queue_music</i> ${name}`;
                el.onclick = () => openPlaylist(name);
                el.oncontextmenu = (e) => {
                    e.preventDefault();
                    const action = prompt(`Manage Playlist: "${name}"\n\nType 'rename' to change name.\nType 'delete' to remove.`, "rename");
                    if (action === 'delete') {
                        if(confirm(`Delete "${name}"?`)) {
                            delete playlists[name];
                            saveStoredPlaylists(playlists);
                        }
                    } else if (action === 'rename') {
                        const newName = prompt("Enter new name:", name);
                        if (newName && newName !== name) {
                            playlists[newName] = playlists[name];
                            delete playlists[name];
                            saveStoredPlaylists(playlists);
                        }
                    }
                };
                grid.appendChild(el);
            });
        }

        function openPlaylist(name) {
            const playlists = getStoredPlaylists();
            document.getElementById('speedDial').style.display = 'none';
            document.getElementById('librarySection').style.display = 'none';
            
            const titleDiv = document.getElementById('resultsTitle');
            titleDiv.style.display = 'block';
            titleDiv.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span>ðŸ“‚ ${name}</span>
                    <button onclick="resetView()" style="background:#333; color:white; border:none; padding:5px 15px; border-radius:15px; cursor:pointer; font-size:14px;">Close</button>
                </div>`;

            const grid = document.getElementById('results');
            grid.innerHTML = '';

            if(playlists[name]) {
                playlists[name].forEach(song => {
                    const el = document.createElement('div');
                    el.className = 'card';
                    el.onclick = () => playSong(song);

                    const btn = document.createElement('button');
                    btn.className = 'action-btn delete-btn';
                    btn.innerHTML = '<i class="material-icons">delete</i>';
                    btn.style.background = 'rgba(200, 0, 0, 0.8)';
                    btn.onclick = (e) => { e.stopPropagation(); removeFromPlaylist(name, song.id); };

                    el.innerHTML = `<img src="${song.cover}"><h3>${song.title}</h3><p>${song.artist}</p>`;
                    el.appendChild(btn);
                    grid.appendChild(el);
                });
            }
        }

        function logout() { location.reload(); }

        // --- YOUTUBE PLAYER & VISUALIZER LOGIC ---
        var player;
        window.onload = function() {
            renderLibrary();
            google.accounts.id.initialize({ 
                client_id: "1008834040580-n0hmhrtr6cmho2prg3i992hq5l77lpd7.apps.googleusercontent.com", 
                callback: handleCredentialResponse 
            });
            google.accounts.id.renderButton(document.getElementById("googleBtn"), { theme: "filled_black", size: "medium", shape: "pill" });
            
            var tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            document.body.appendChild(tag);
        };

        function onYouTubeIframeAPIReady() { 
            player = new YT.Player('hidden-player', { height: '180', width: '320', events: { 'onStateChange': onPlayerStateChange } }); 
        }

        // Logic to toggle visualizer
        function onPlayerStateChange(event) {
            const icon = document.getElementById('playIcon');
            const waves = document.getElementById('waves');

            if(event.data == YT.PlayerState.PLAYING) {
                icon.innerText = 'pause';
                waves.classList.add('active'); // Start Animation
            } else {
                icon.innerText = 'play_arrow';
                waves.classList.remove('active'); // Stop Animation
            }
        }

        function playSong(song) {
            document.getElementById('title').innerText = song.title;
            document.getElementById('artist').innerText = song.artist;
            document.getElementById('art').src = song.cover;
            if(player) { player.loadVideoById(song.id); player.playVideo(); }
        }

        function togglePlay() { 
            if(player && player.getPlayerState() == 1) player.pauseVideo(); 
            else if(player) player.playVideo(); 
        }
    </script>
</body>
</html>